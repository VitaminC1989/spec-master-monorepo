# 数据持久化验证指南

本指南帮助你验证 SpecMaster 的数据持久化功能是否正常工作。

## 📝 测试步骤

### 测试 1：基本数据持久化

1. **添加数据**
   - 创建一个新款号
   - 添加颜色版本
   - 上传样衣图片
   - 添加配料明细和色卡

2. **刷新页面**
   - 按 `Ctrl+R` 或 `Cmd+R` 刷新浏览器
   - 数据应该全部保留
   - 图片应该正常显示

3. **关闭浏览器**
   - 完全关闭浏览器
   - 重新打开浏览器访问应用
   - 数据应该全部保留

### 测试 2：数据导出和导入

1. **导出数据**
   - 点击顶部导航栏的"数据管理"按钮
   - 点击"导出数据"
   - 下载 JSON 文件（如 `specmaster_backup_2025-12-27.json`）

2. **修改数据**
   - 删除一些款号或配料
   - 或添加新的测试数据

3. **导入数据**
   - 点击"数据管理" → "导入数据"
   - 选择之前导出的 JSON 文件
   - 确认导入
   - 页面会自动刷新
   - 验证数据恢复到导出时的状态

### 测试 3：图片持久化

1. **上传图片并记录 URL**
   - 上传一张样衣图片
   - 打开浏览器开发者工具（F12）
   - 在控制台查看上传成功的 URL
   - 例如：`http://t7x92jhy0.hd-bkt.clouddn.com/samples/20251227/xxx.jpg`

2. **复制 URL 到浏览器**
   - 在新标签页访问这个 URL
   - 图片应该能正常显示

3. **刷新页面验证**
   - 刷新应用页面
   - 图片应该从七牛云 CDN 正常加载
   - 不依赖本地存储

### 测试 4：离线模式（部分）

**可用功能**：
- ✅ 浏览已有数据
- ✅ 编辑文本内容
- ✅ 添加、删除配料明细
- ✅ 查看已上传的图片（如果浏览器缓存了）

**不可用功能**：
- ❌ 上传新图片（需要网络连接到七牛云）
- ❌ 图片首次加载（需要网络）

## 📊 数据存储位置

### IndexedDB（浏览器本地）

**存储内容**：
- 款号数据（style_no, customer_id 等）
- 颜色版本数据（color_name, size_range 等）
- 配料明细数据（material_name, supplier 等）
- 规格明细数据（嵌套在配料中）
- 图片 URL（字符串，指向七牛云）

**查看方式**：
1. 打开浏览器开发者工具（F12）
2. Application / 应用 → Storage → IndexedDB
3. 展开 `SpecMasterDB` 数据库
4. 查看各个表的数据

### 七牛云（远程 CDN）

**存储内容**：
- 样衣图片文件（samples/目录）
- 色卡图片文件（colors/目录）

**访问方式**：
- 通过 CDN URL 直接访问
- 浏览器会自动缓存常用图片

## 🔍 故障排查

### 问题 1：数据丢失

**可能原因**：
- 浏览器清除了网站数据
- 使用了无痕/隐私模式
- 浏览器存储配额已满

**解决方案**：
- 定期使用"导出数据"功能备份
- 不要在无痕模式下使用
- 清理浏览器其他网站的数据

### 问题 2：图片无法显示

**检查清单**：
1. ✅ 网络连接正常
2. ✅ 七牛云 CDN 域名可访问
3. ✅ 图片 URL 格式正确
4. ✅ 七牛空间设置为公开

**验证方法**：
```bash
# 在浏览器控制台运行
fetch('http://t7x92jhy0.hd-bkt.clouddn.com/samples/test.jpg')
  .then(res => console.log('状态:', res.status))
  .catch(err => console.error('错误:', err))
```

### 问题 3：导入失败

**常见原因**：
- JSON 文件格式错误
- 文件损坏
- 版本不兼容

**解决方案**：
1. 确认 JSON 文件完整
2. 用文本编辑器打开检查格式
3. 尝试重新导出

## 📈 数据容量限制

### IndexedDB 配额

**不同浏览器**：
- Chrome/Edge: ~60% 可用磁盘空间
- Firefox: ~50% 可用磁盘空间
- Safari: ~1GB（移动端更少）

**实际使用**：
- 纯文本数据：几 KB - 几 MB
- 图片 URL：每条约 100 字节
- 千条记录：约 1-10 MB

**结论**：对于服装配方管理系统，容量完全够用。

### 七牛云存储

**免费配额**：
- 存储空间：10 GB
- 下载流量：10 GB/月
- 测试域名：30 天有效期

**估算**：
- 每张图片：100 KB - 500 KB
- 1000 张图片：~100-500 MB
- 远小于免费配额

## 💡 最佳实践

### 1. 定期备份

**建议频率**：
- 每周导出一次数据
- 重要修改后立即导出
- 存储在云盘或多个位置

### 2. 数据管理

**建议**：
- 定期清理不需要的测试数据
- 使用有意义的款号命名
- 及时更新客户和供应商信息

### 3. 图片管理

**建议**：
- 压缩图片后再上传（减少存储和流量）
- 使用统一的图片尺寸
- 定期检查七牛云使用情况

### 4. 浏览器选择

**推荐**：
- Chrome / Edge（最佳兼容性）
- Firefox（良好支持）
- Safari（部分限制）

## 🎯 完整离线方案（可选）

如果需要完全离线使用，可以考虑：

### 方案 1：PWA（渐进式 Web 应用）

**优点**：
- 可以安装到桌面
- 离线缓存应用文件
- 更接近原生应用体验

**需要添加**：
- Service Worker
- manifest.json
- 离线页面

### 方案 2：Electron 桌面应用

**优点**：
- 完全离线运行
- 图片也存储在本地
- 跨平台（Windows/Mac/Linux）

**需要改造**：
- 打包为 Electron 应用
- 图片存储改为本地文件系统
- 移除七牛云依赖

### 方案 3：混合模式（推荐）

**在线时**：
- 图片上传到七牛云
- 享受 CDN 加速

**离线时**：
- 继续编辑文本数据
- 查看已缓存的图片
- 新图片等有网络时再上传

---

## ✅ 验证清单

完成以下测试，确保数据持久化正常：

- [ ] 添加数据后刷新页面，数据保留
- [ ] 关闭浏览器重开，数据保留
- [ ] 导出 JSON 文件成功
- [ ] 导入 JSON 文件恢复数据成功
- [ ] 上传图片后能正常显示
- [ ] 图片 URL 可以直接访问
- [ ] 开发者工具中能看到 IndexedDB 数据

全部通过 ✅ 说明数据持久化功能正常！
