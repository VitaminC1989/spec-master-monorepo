# 本地开发环境测试图片上传

本指南说明如何在本地开发环境测试七牛云图片上传功能。

## 🚀 快速开始（两行命令）

```bash
# 终端 1: 启动本地 Token 服务
npm run dev:token

# 终端 2: 启动前端开发服务器
npm run dev
```

就这么简单！现在你可以在本地测试图片上传功能了。

---

## 📖 详细说明

### 架构

```
浏览器 (http://localhost:3000)
   ↓
   请求 /api/qiniu-token
   ↓
Vite Proxy (自动转发)
   ↓
本地 Token 服务 (http://localhost:3001)
   ↓
   返回上传凭证
   ↓
浏览器直接上传到七牛云
```

### 工作原理

1. **本地 Token 服务** (`scripts/local-qiniu-server.js`)
   - 监听在 `http://localhost:3001`
   - 读取 `.env.local` 中的七牛云密钥
   - 生成上传凭证并返回

2. **Vite 代理** (`vite.config.ts`)
   - 前端请求 `/api/qiniu-token` 时
   - 自动转发到 `http://localhost:3001`
   - 无需配置跨域

3. **前端上传** (`src/utils/qiniuUpload.ts`)
   - 获取凭证后直接上传到七牛云
   - 上传成功返回 CDN URL

---

## 🧪 测试步骤

### 1. 启动服务

**终端 1 - Token 服务**
```bash
npm run dev:token
```

应该看到：
```
🚀 本地七牛 Token 服务已启动！
📍 地址: http://localhost:3001
🔗 Token API: http://localhost:3001/api/qiniu-token

📝 配置信息:
   AccessKey: ✅ 已配置
   SecretKey: ✅ 已配置
   Bucket: specmaster-demo
   Domain: http://t7x92jhy0.hd-bkt.clouddn.com

💡 提示: 前端开发服务器会自动代理到此服务
   运行 npm run dev 启动前端即可测试
```

**终端 2 - 前端**
```bash
npm run dev
```

浏览器会自动打开 `http://localhost:3000`

### 2. 测试上传功能

#### 测试 1: 样衣图片上传
1. 访问款号列表 → 点击任一款号
2. 点击"新建颜色版本"按钮
3. 填写颜色名称（如：天蓝色）
4. 点击"上传图片"，选择一张图片
5. 观察上传进度
6. 提交表单

#### 测试 2: 色卡图片上传
1. 在款号详情页面，找到任一配料明细
2. 点击"编辑"按钮
3. 在辅料颜色字段，点击"上传色卡"
4. 选择一张图片
5. 观察上传进度
6. 保存修改

### 3. 验证上传结果

**浏览器控制台（F12）**

成功时应该看到：
```
样衣图片上传进度: 100%
七牛上传成功: http://t7x92jhy0.hd-bkt.clouddn.com/samples/20251227/1703678901234_abc123.jpg
```

**Network 面板**

- 请求 `/api/qiniu-token` → 200 OK
- 响应包含 `token`, `domain`, `expires`
- 上传请求直接发送到 `up-z2.qiniup.com`（七牛云）

**Token 服务终端**

每次请求会看到：
```
✅ [14:30:15] Token 生成成功
```

---

## 🔧 常见问题

### Q1: Token 服务启动失败

**错误**：`❌ 端口 3001 已被占用`

**解决**：
```bash
# 查找占用端口的进程
lsof -ti:3001

# 杀死进程
kill -9 $(lsof -ti:3001)

# 或者修改端口
# 编辑 scripts/local-qiniu-server.js
# 将 PORT = 3001 改为其他端口（如 3002）
# 同时修改 vite.config.ts 中的 target
```

### Q2: 环境变量未配置

**错误**：`❌ 未配置`

**解决**：
1. 确认 `.env.local` 文件存在
2. 检查文件中是否包含：
   ```
   QINIU_ACCESS_KEY=xxx
   QINIU_SECRET_KEY=xxx
   QINIU_BUCKET=xxx
   QINIU_DOMAIN=xxx
   ```
3. 重启 Token 服务

### Q3: 上传失败 - 获取凭证失败

**检查清单**：
1. ✅ Token 服务是否正在运行？
2. ✅ 浏览器访问 `http://localhost:3001/api/qiniu-token` 是否返回 JSON？
3. ✅ Vite 代理是否配置正确？（检查 `vite.config.ts`）
4. ✅ 前端是否使用正确的端点？（检查 `.env.local` 中的 `VITE_QINIU_TOKEN_ENDPOINT`）

### Q4: 上传失败 - 401/403 错误

**原因**：七牛云密钥错误或过期

**解决**：
1. 访问 [七牛云密钥管理](https://portal.qiniu.com/user/key)
2. 确认 AccessKey 和 SecretKey 是否正确
3. 检查存储空间名称是否正确
4. 确认存储空间设置为**公开空间**

### Q5: 图片无法访问（404）

**原因**：CDN 域名配置错误

**解决**：
1. 访问七牛云控制台 → 对象存储 → 你的空间
2. 复制正确的 CDN 域名
3. 更新 `.env.local` 中的 `QINIU_DOMAIN`
4. 重启 Token 服务

---

## 💡 提示

### 性能优化

如果不需要实时生成 Token，可以使用生产环境的 API：

**修改 `vite.config.ts`：**
```typescript
proxy: {
  '/api': {
    target: 'https://your-project.vercel.app',  // 你的 Vercel 地址
    changeOrigin: true,
  },
}
```

这样就不需要启动本地 Token 服务了。

### 调试技巧

**查看详细日志**：

编辑 `scripts/local-qiniu-server.js`，在生成 Token 后添加：
```javascript
console.log('Token:', token.substring(0, 50) + '...');
console.log('Policy:', JSON.stringify(policy, null, 2));
```

**测试 Token 是否有效**：

使用 curl 测试：
```bash
curl http://localhost:3001/api/qiniu-token
```

---

## 📝 开发流程建议

### 日常开发
```bash
# 一键启动（需要打开两个终端）
npm run dev:token  # 终端 1
npm run dev        # 终端 2
```

### 只开发前端（不测试上传）
```bash
npm run dev
# 上传功能会失败，但不影响其他功能开发
```

### 使用生产环境 API
```bash
# 修改 vite.config.ts 指向生产环境
npm run dev
# 只需要一个终端
```

---

## 🎯 部署到生产环境

本地测试完成后，部署到 Vercel：

```bash
# 提交代码
git add .
git commit -m "feat: 添加七牛云图片上传功能"

# 部署到生产环境
vercel --prod
```

生产环境会自动使用 Vercel Serverless 函数，无需本地 Token 服务。
