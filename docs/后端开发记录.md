# SpecMaster 后端开发记录

## 开发概述

**开发日期**: 2026-01-13
**技术栈**: NestJS 11 + Prisma 7.2 + PostgreSQL 16
**基于文档**: `docs/数据库设计文档.md`

---

## 完成的工作

### 1. 基础架构搭建

#### 1.1 依赖安装
```bash
pnpm add class-validator class-transformer
```

#### 1.2 数据库迁移
```bash
npx prisma migrate dev --name init_schema
```
- 创建了 7 张核心表：`styles`, `color_variants`, `bom_items`, `spec_details`, `customers`, `sizes`, `units`
- 创建了 3 张扩展表：`suppliers`, `attachments`, `operation_logs`

#### 1.3 项目结构
```
apps/api/src/
├── main.ts                          # 应用入口（ValidationPipe, CORS, Swagger）
├── app.module.ts                    # 根模块（注册所有业务模块）
├── prisma.service.ts                # Prisma 服务
├── prisma/
│   └── prisma.module.ts             # Prisma 全局模块
├── common/
│   ├── dto/pagination.dto.ts        # 分页 DTO
│   ├── utils/query-builder.util.ts  # Refine filters → Prisma where 转换
│   ├── interceptors/transform.interceptor.ts  # 响应格式转换
│   └── pipes/parse-filters.pipe.ts  # 查询参数解析
└── modules/
    ├── customers/                   # 客户模块
    ├── styles/                      # L1 款号模块
    ├── variants/                    # L2 颜色版本模块
    ├── bom-items/                   # L3 配料明细模块
    ├── spec-details/                # L4 规格明细模块
    ├── sizes/                       # 尺码模块
    └── units/                       # 单位模块
```

---

### 2. API 端点清单

| 模块 | 端点 | 方法 | 功能 |
|------|------|------|------|
| **Customers** | `/api/customers` | GET | 获取客户列表 |
| | `/api/customers/:id` | GET | 获取客户详情 |
| | `/api/customers` | POST | 创建客户 |
| | `/api/customers/:id` | PUT | 更新客户 |
| | `/api/customers/:id` | DELETE | 删除客户（软删除） |
| **Styles** | `/api/styles` | GET | 获取款号列表 |
| | `/api/styles/:id` | GET | 获取款号详情（含颜色版本） |
| | `/api/styles` | POST | 创建款号 |
| | `/api/styles/:id` | PUT | 更新款号 |
| | `/api/styles/:id` | DELETE | 删除款号（级联软删除） |
| **Variants** | `/api/variants` | GET | 获取颜色版本列表 |
| | `/api/variants/:id` | GET | 获取颜色版本详情（含配料和规格） |
| | `/api/variants` | POST | 创建颜色版本 |
| | `/api/variants/:id` | PUT | 更新颜色版本 |
| | `/api/variants/:id` | DELETE | 删除颜色版本（级联删除） |
| | `/api/styles/:styleId/variants/:variantId/clone` | POST | **深度克隆颜色版本** |
| **BOM Items** | `/api/bom-items` | GET | 获取配料明细列表 |
| | `/api/bom-items/:id` | GET | 获取配料明细详情（含规格） |
| | `/api/bom-items` | POST | 创建配料明细（可嵌套创建规格） |
| | `/api/bom-items/:id` | PUT | 更新配料明细（可替换规格） |
| | `/api/bom-items/:id` | DELETE | 删除配料明细（级联删除规格） |
| **Spec Details** | `/api/spec-details` | GET/POST/PUT/DELETE | 规格明细 CRUD |
| **Sizes** | `/api/sizes` | GET/POST/PUT/DELETE | 尺码管理 CRUD |
| **Units** | `/api/units` | GET/POST/PUT/DELETE | 单位管理 CRUD |

---

### 3. 关键功能实现

#### 3.1 Refine DataProvider 兼容格式

**列表响应**:
```json
{
  "data": [...],
  "total": 100
}
```

**单条响应**:
```json
{
  "data": { ... }
}
```

**查询参数**:
```
GET /api/styles?filters=[{"field":"customer_id","operator":"eq","value":1}]&pagination={"current":1,"pageSize":10}
```

#### 3.2 customer_name 自动同步

- 创建 Style 时，自动从 Customer 表查询并填充 `customer_name`
- 更新 Style 的 `customer_id` 时，自动更新 `customer_name`
- 更新 Customer 的名称时，自动同步到所有关联 Style

#### 3.3 深度克隆（核心功能）

**端点**: `POST /api/styles/:styleId/variants/:variantId/clone`

**请求体**:
```json
{
  "new_color_name": "粉色",
  "copy_sample_image": true
}
```

**响应**:
```json
{
  "data": {
    "id": 2,
    "color_name": "粉色",
    "cloned_bom_count": 5,
    "cloned_spec_count": 20
  }
}
```

**实现逻辑**:
1. 验证源颜色版本存在且属于指定款号
2. 检查新颜色名称在该款号下唯一
3. 使用事务执行：
   - 创建新的颜色版本
   - 复制所有配料明细
   - 复制每个配料的所有规格明细

#### 3.4 软删除 + 级联删除

- **Style 删除**: 软删除 Style → 软删除所有 ColorVariant → 软删除所有 BOMItem → 硬删除所有 SpecDetail
- **ColorVariant 删除**: 软删除 ColorVariant → 软删除所有 BOMItem → 硬删除所有 SpecDetail
- **BOMItem 删除**: 软删除 BOMItem → 硬删除所有 SpecDetail

#### 3.5 嵌套创建

创建 BOMItem 时可以同时创建 SpecDetails:
```json
{
  "variant_id": 1,
  "material_name": "5号树脂拉链",
  "usage": 1,
  "unit": "条",
  "specDetails": [
    {"size": "S", "spec_value": "58", "spec_unit": "cm"},
    {"size": "M", "spec_value": "60", "spec_unit": "cm"}
  ]
}
```

---

### 4. 字段命名约定

| 层级 | 命名风格 | 示例 |
|------|---------|------|
| 前端 API | snake_case | `style_no`, `customer_name` |
| Prisma 模型 | camelCase | `styleNo`, `customerName` |
| 数据库列 | snake_case | `style_no`, `customer_name` |

Service 层负责响应时将 camelCase 转换为 snake_case。

---

### 5. 验证测试结果

```bash
# 创建客户
curl -X POST http://localhost:3000/api/customers \
  -H "Content-Type: application/json" \
  -d '{"customer_name": "优衣库"}'
# ✅ 成功返回 {"data": {"id": 1, "customer_name": "优衣库", ...}}

# 创建款号（自动同步 customer_name）
curl -X POST http://localhost:3000/api/styles \
  -H "Content-Type: application/json" \
  -d '{"style_no": "9128", "style_name": "儿童拼色马甲", "customer_id": 1}'
# ✅ 成功返回 {"data": {"id": 1, "customer_name": "优衣库", ...}}

# 创建颜色版本
curl -X POST http://localhost:3000/api/variants \
  -H "Content-Type: application/json" \
  -d '{"style_id": 1, "color_name": "灰色"}'
# ✅ 成功

# 创建配料（嵌套创建规格）
curl -X POST http://localhost:3000/api/bom-items \
  -H "Content-Type: application/json" \
  -d '{"variant_id": 1, "material_name": "拉链", "usage": 1, "unit": "条", "specDetails": [...]}'
# ✅ 成功

# 深度克隆
curl -X POST http://localhost:3000/api/styles/1/variants/1/clone \
  -H "Content-Type: application/json" \
  -d '{"new_color_name": "粉色"}'
# ✅ 成功返回 {"data": {"id": 2, "cloned_bom_count": 1, "cloned_spec_count": 3}}
```

---

### 6. 启动命令

```bash
# 启动 PostgreSQL
docker-compose up -d

# 启动后端开发服务器
cd apps/api && pnpm start:dev

# 访问 Swagger 文档
open http://localhost:3000/docs
```

---

### 7. 后续工作

- [x] 后端 API 开发完成
- [ ] 前端集成真实 HTTP provider
- [ ] 端到端测试
- [ ] 数据库触发器优化（可选）
- [ ] 单元测试补充（可选）

---

## 文件变更清单

### 新增文件
- `src/prisma/prisma.module.ts`
- `src/common/dto/pagination.dto.ts`
- `src/common/utils/query-builder.util.ts`
- `src/common/interceptors/transform.interceptor.ts`
- `src/common/pipes/parse-filters.pipe.ts`
- `src/common/index.ts`
- `src/modules/customers/**`
- `src/modules/styles/**`
- `src/modules/variants/**`
- `src/modules/bom-items/**`
- `src/modules/spec-details/**`
- `src/modules/sizes/**`
- `src/modules/units/**`

### 修改文件
- `src/main.ts` - 添加 ValidationPipe, CORS, Swagger 配置
- `src/app.module.ts` - 注册所有业务模块
- `prisma/migrations/` - 数据库迁移文件
